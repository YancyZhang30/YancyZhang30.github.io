# npm 和 pnpm

## npm扁平化
通过 npm 生成的 node_modules 结构通常是一个「扁平化 的目录结构」，其中包含项目的所有依赖项。当您使用 npm 安装项目的依赖项时，相关的包将直接安装到项目的 node_modules 目录中。例如，假设你的项目依赖于包 A 和包 B，它们的安装目录结构可能如下所示：
```js
Project
└── node_modules
    ├── package-A
    └── package-B

// node_modules 结构是扁平化的，但每个依赖项的包内部结构可能是嵌套的
```
缺点：
- 冗余依赖项

由于每个依赖项都被直接放置在 node_modules 目录下，如果多个依赖项依赖于同一个包的不同版本，那么这个包将会在 node_modules 目录下重复出现多次，造成了冗余的存储。
```js
Project
└── node_modules
    ├── package-A
    │   └── node_modules
    │       └── shared-package@1.0.0
    └── package-B
        └── node_modules
            └── shared-package@2.0.0
```
- 磁盘占用

由于每个依赖项都被直接放置在 node_modules 目录下，即使同一个依赖项在不同的包中重复出现，也会占用额外的磁盘空间
```js
Project
└── node_modules
    ├── package-A
    │   └── node_modules
    │       └── shared-package@1.0.0
    └── package-B
        └── node_modules
            └── shared-package@1.0.0
```

## npm优化
npm v3（2015年）是 npm 包管理器的一个重要里程碑，引入了一些重大的变化和改进！
1. 扁平化依赖：npm v3 引入了「扁平化依赖」的概念（npm v5 做了完善和优化），即将依赖项的多个版本共享在一个统一的层次结构中。这样可以避免传统的嵌套依赖结构，减少了冗余和冲突，从而降低了项目的磁盘空间占用和安装时间。
```js
Project
└── node_modules
    ├── package-A
    ├── package-B
    ├── shared-package@1.0.0
    └── shared-package@2.0.0 // npm v5 才能做到
```
2. 并行安装

问题：
1. npm v3 这种「扁平化依赖」的思想虽然有效避免了冗余的依赖项，但也使得项目/包可以访问到并不依赖的包，可能产生安全问题 ➡️「幽灵依赖」。因为相同依赖包被提升到了顶层，所以整个项目都可以访问该依赖，但是package.json可能并没有声明。

2. 不同包依赖同一个包的版本不同时，多个版本的包只能有一个被提升上来，其余版本的包会嵌套安装到各自的依赖当中，哪个版本的包被提升，依赖于包的安装顺序。
## pnpm
「pnpm」的主要特点之一是它使用一种称为「虚拟化节点模块」的技术来管理依赖项。它通过在单个磁盘位置存储依赖项的多个版本来减少磁盘占用空间，并通过「软连接 — 符号链接」将它们正确引用到项目中，这种方法还可以加快安装和更新依赖项的速度！

### store
pnpm 有一个 store 的概念（为了方便记忆，可以联想成 Vuex 的 store，全局状态管理），store 目录内部使用「基于内容寻址」的文件系统来存储磁盘上所有的文件。

基于内容寻址是一种文件系统的设计原则，以文件内容的哈希值作为文件的唯一标识符，并将文件存储在以哈希值命名的目录中。这样的设计使得相同内容的文件只会存储一次，避免了重复存储相同文件的问题。

![store](https://s11.ax1x.com/2024/02/22/pFNsQyj.png)
### link

#### 1. 硬链接hard link
硬链接就是同一个文件的一个或多个文件名，它所引用的是文件的物理数据而不是文件在文件结构中的位置，使得用户可以通过不同的路径引用方式去找到某个文件。pnpm 会在全局的 store 目录里存储项目 node_modules 文件的硬连接。但是，硬链接只能用于文件不能用于目录（可能导致目录循环）。

硬链接的特点是，无论有多少个硬链接指向相同的数据块，它们都被视为相互独立的完整文件副本。因此，硬链接不会占用额外的磁盘空间，因为它们共享相同的数据块。
#### 2. 软链接symbolic link
软链接，又称为符号链接，是一个指向另一个文件或目录的引用，类似于创建一个快捷方式。与硬链接不同，软链接创建的链接文件保存的是被链接文件的「路径信息」，而不是实际的文件内容或索引节点。当访问软链接时，操作系统会跟随链接并转到被链接的文件或目录。

硬链接指向物理资源，软链接则是指向硬链接。

### .pnpm
.pnpm/ 为虚拟磁盘目录，它以平铺的形式储存着所有的包。pnpm 使用「软链接 + 平铺」目录结合的方式来构建一个嵌套结构：
![.pnpm](https://s11.ax1x.com/2024/02/22/pFNsRpD.png)


### 依赖包寻址
```js
node_modules/f // 在 node_modules 文件夹寻找依赖，并遵循就近原则

—> 软链接 node_modules/.pnpm/f@1.0.0/node_modules/f // 解决一个项目内的代码重复引用问题

—> 硬链接 ~/.pnpm-store/v3/files/00/xxxxxx // 解决项目间的包重复拷贝问题
```

### 平铺
pnpm 包的依赖项与依赖包的位置位于同一目录级别：f 这个依赖的内部相关依赖会被平铺到 .pnpm/f@1.0.0/node_modules/ 这个目录下面，而不是 .pnpm/f@1.0.0/node_modules/f/node_modules/
```js
node_modules
├── f -> ./.pnpm/f@1.0.0/node_modules/f
└── .pnpm
       ├── b@1.0.0
       │    └── node_modules
       │          └── b -> <store>/b
       └── f@1.0.0
             └── node_modules
                   ├── f -> <store>/f
                   └── b -> ../../b@1.0.0/node_modules/b
```
这个平铺的结构使得所有被提升的包都可以访问。不但保留了包之间的相互隔离，而且避免了创建的嵌套 node_modules 引起的长路径问题。